version: "2"
services:
    reverseproxy:
        image: traefik
        command: --web --docker --docker.domain=@domain@ --logLevel=ERROR
        ports:
            - "80:80"
            - "443:443"
            - "8089:8080"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./apps/reverseproxy/config.toml:/traefik.toml
    database:
        container_name: 'database'
        image: 'sameersbn/postgresql:9.4-24'
        volumes:
            - ./apps/db/state:/var/lib/postgresql
    appconfig:
        build: ./apps/appconfig
        environment:
            TGWEBHOOK: @webhook@
            TGTOKEN: @token@
            LOGLEVEL: @appLogLevel@
    httplistener:
        build: ./apps/httplistener
        labels:
            - "traefik.backend=httplistener"
            - "traefik.frontend.rule=Host:@hostname@"
        links:
            - msgsys
        environment:
            NATSADDR: "nats://msgsys:4233"
            CLIENTID: httplistener
            LOGLEVEL: @appLogLevel@
            LISTENADDR: ":80"
            PUBNAME: channel1
    pump:
        build: ./apps/pump
        links:
            - msgsys
        environment:
            NATSADDR: "nats://msgsys:4233"
            CLIENTID: pump
            LOGLEVEL: @appLogLevel@
            PUBNAME: channel1
            TGTOKEN: @token@
    msgsys:
        image: nats
        container_name: 'msgsys'
        command: -p 4233
    appworker:
        build: ./apps/appworker
        links:
            - msgsys
            - database
        volumes_from:
            - "database"
        environment:
            NATSADDR: "nats://msgsys:4233"
            CLIENTID: appworker
            LOGLEVEL: @appLogLevel@
            SUBNAME: channel1
            TGTOKEN: @token@
            DBADDR: "database:5432"
            DBNAME: app
            DBUSER: app
            DBPASS: apppassword